# Система покраски реальных стен с использованием компьютерного зрения

## Обзор

Система покраски реальных стен позволяет обнаруживать стены в реальном мире с помощью компьютерного зрения и перекрашивать их в виртуальном пространстве, создавая эффект дополненной реальности, аналогичный приложению Dulux Visualizer.

## Возможности

- Обнаружение стен с помощью компьютерного зрения (OpenCV)
- Создание 3D-моделей стен в реальном времени
- Покраска стен в различные цвета
- Интуитивно понятный пользовательский интерфейс
- Возможность сброса цветов стен
- Предпросмотр цвета перед покраской

## Требования

- Unity 2021.3 или новее
- OpenCVForUnity (активирован для вашей платформы)
- Устройство с камерой

## Установка и настройка

### Быстрая настройка через редактор

1. Откройте меню **Remalux > Создать сцену покраски реальных стен** в Unity.
2. Выберите место для сохранения новой сцены.
3. Система автоматически создаст все необходимые объекты, материалы и префабы.

### Ручная настройка

Если вы предпочитаете настроить систему вручную, выполните следующие шаги:

1. Создайте новую сцену в Unity.
2. Создайте пустой GameObject и назовите его "RealWallPaintingSystem".
3. Добавьте следующие компоненты:
   - `RealWallPaintingController`
   - `WallDetector`
   - `WallMeshBuilder`
4. Настройте ссылки между компонентами.
5. Создайте материалы для покраски и назначьте их в компоненте `RealWallPaintingController`.
6. Создайте UI элементы (Canvas, кнопки цветов, кнопка сброса).

## Использование системы

1. **Запустите сцену** в режиме Play.
2. **Направьте камеру на стены** в реальном мире.
3. Система автоматически обнаружит стены и создаст их 3D-модели.
4. **Выберите цвет** из палитры цветов в нижней части экрана.
5. **Нажмите на стену**, чтобы покрасить ее выбранным цветом.
6. **Нажмите кнопку "Сбросить"**, чтобы вернуть все стены к исходному цвету.

## Структура системы

### Основные компоненты

- **RealWallPaintingController**: Основной контроллер системы, координирует работу всех компонентов.
- **WallDetector**: Обнаруживает стены с помощью компьютерного зрения.
- **WallMeshBuilder**: Создает 3D-модели стен на основе обнаруженных данных.
- **WallMaterialInstanceTracker**: Отслеживает материалы стен и управляет их изменением.
- **SimpleColorButton**: Компонент для кнопок выбора цвета.
- **SimpleColorPreview**: Компонент для предпросмотра цвета на стене.

### Алгоритм обнаружения стен

1. Получение изображения с камеры.
2. Преобразование в оттенки серого.
3. Применение детектора краев Canny.
4. Обнаружение линий с помощью преобразования Хафа.
5. Классификация линий на вертикальные и горизонтальные.
6. Группировка близких линий.
7. Определение стен на основе пар вертикальных линий.
8. Создание 3D-моделей для обнаруженных стен.

## Настройка параметров

### WallDetector

- **cannyThreshold1**, **cannyThreshold2**: Пороги для детектора краев Canny.
- **minLineLength**: Минимальная длина линии для обнаружения.
- **maxLineGap**: Максимальный разрыв между линиями.
- **minWallHeight**, **minWallWidth**: Минимальные размеры для определения стены.
- **showDebugImage**: Включает/выключает отображение отладочной информации.

### WallMeshBuilder

- **wallDistance**: Расстояние от камеры до стены.
- **wallDepth**: Толщина стены.
- **wallExtensionFactor**: Коэффициент расширения стены.

### RealWallPaintingController

- **raycastDistance**: Максимальное расстояние для определения стены при нажатии.
- **showColorPreview**: Включает/выключает предпросмотр цвета.

## Устранение неполадок

### Стены не обнаруживаются

- Убедитесь, что камера направлена на хорошо освещенные вертикальные поверхности.
- Попробуйте настроить параметры `cannyThreshold1` и `cannyThreshold2` в компоненте `WallDetector`.
- Увеличьте значение `maxLineGap` для лучшего соединения фрагментированных линий.

### Ошибки с OpenCVForUnity

- Убедитесь, что плагин OpenCVForUnity активирован для вашей платформы.
- Проверьте, что все необходимые DLL-файлы включены в сборку.

### Проблемы с покраской стен

- Убедитесь, что режим покраски включен (`isPaintingMode = true`).
- Проверьте, что материалы для покраски правильно настроены.
- Убедитесь, что стены имеют компонент `WallMaterialInstanceTracker`.

## Расширение функциональности

Вы можете расширить функциональность системы следующими способами:

1. **Добавление новых материалов**: Создайте новые материалы и добавьте их в массив `paintMaterials`.
2. **Улучшение алгоритма обнаружения стен**: Модифицируйте класс `WallDetector` для более точного обнаружения стен.
3. **Добавление текстур**: Используйте текстурированные материалы вместо простых цветов.
4. **Сохранение состояния**: Добавьте функциональность для сохранения и загрузки состояния покраски стен.
5. **Интеграция с AR Foundation**: Используйте AR Foundation для более точного определения плоскостей и их отслеживания.

## Примечания

- Система использует OpenCV для обнаружения стен, что может быть ресурсоемким на мобильных устройствах.
- Для лучшей производительности рекомендуется использовать устройства с хорошей камерой и достаточной вычислительной мощностью.
- Качество обнаружения стен зависит от освещения и текстуры поверхностей. 